var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,n=0,t=arguments.length;n<t;n++)e+=arguments[n].length;var s=Array(e),i=0;for(n=0;n<t;n++)for(var a=arguments[n],r=0,m=a.length;r<m;r++,i++)s[i]=a[r];return s};import Mmenu from"../../core/oncanvas/mmenu.oncanvas";import options from"./_options";import configs from"./_configs";import translate from"./translations/translate";import{extendShorthandOptions}from"./_options";import*as DOM from"../../_modules/dom";import*as events from"../../_modules/eventlisteners";import{type,extend}from"../../_modules/helpers";translate(),Mmenu.options.searchfield=options,Mmenu.configs.searchfield=configs;export default function(){var e=this,n=extendShorthandOptions(this.opts.searchfield);this.opts.searchfield=extend(n,Mmenu.options.searchfield);this.conf.searchfield;n.add&&(this.bind("close:start",function(){DOM.find(e.node.menu,".mm-searchfield").forEach(function(e){e.blur()})}),this.bind("initPanel:after",function(t){var s=null;n.panel.add&&(s=initSearchPanel.call(e));var i=null;switch(n.addTo){case"panels":i=[t];break;case"panel":i=[s];break;default:"string"==typeof n.addTo?i=DOM.find(e.node.menu,n.addTo):"array"==type(n.addTo)&&(i=n.addTo)}i.forEach(function(t){t=initSearchfield.call(e,t),n.search&&t&&initSearching.call(e,t)}),n.noResults&&initNoResultsMsg.call(e,n.panel.add?s:t)}),this.clck.push(function(n,t){if(t.inMenu&&n.matches(".mm-searchfield__btn")){if(n.matches(".mm-btn_close")){var s=n.closest(".mm-searchfield"),i=DOM.find(s,"input")[0];return i.value="",e.search(i),!0}if(n.matches(".mm-btn_next"))return(s=n.closest("form"))&&s.submit(),!0}}))};var initSearchPanel=function(){var e=this.opts.searchfield,n=(this.conf.searchfield,DOM.children(this.node.pnls,".mm-panel_search")[0]);if(n)return n;n=DOM.create("div.mm-panel.mm-panel_search.mm-hidden"),e.panel.id&&(n.id=e.panel.id),e.panel.title&&n.setAttribute("data-mm-title",e.panel.title);var t=DOM.create("ul");switch(n.append(t),this.node.pnls.append(n),this.initListview(t),this._initNavbar(n),e.panel.fx){case!1:break;case"none":n.classList.add("mm-panel_noanimation");break;default:n.classList.add("mm-panel_fx-"+e.panel.fx)}if(e.panel.splash){var s=DOM.create("div.mm-panel__content");s.innerHTML=e.panel.splash,n.append(s)}return n.classList.add("mm-panel"),n.classList.add("mm-hidden"),this.node.pnls.append(n),n},initSearchfield=function(e){var n=this.opts.searchfield,t=this.conf.searchfield;if(e.parentElement.matches(".mm-listitem_vertical"))return null;if(a=DOM.find(e,".mm-searchfield")[0])return a;function s(e,n){if(n)for(var t in n)e.setAttribute(t,n[t])}var i,a=DOM.create((t.form?"form":"div")+".mm-searchfield"),r=DOM.create("div.mm-searchfield__input"),m=DOM.create("input");(m.type="text",m.autocomplete="off",m.placeholder=this.i18n(n.placeholder),r.append(m),a.append(r),e.prepend(a),s(m,t.input),t.clear)&&((i=DOM.create("a.mm-btn.mm-btn_close.mm-searchfield__btn")).setAttribute("href","#"),r.append(i));(s(a,t.form),t.form&&t.submit&&!t.clear)&&((i=DOM.create("a.mm-btn.mm-btn_next.mm-searchfield__btn")).setAttribute("href","#"),r.append(i));n.cancel&&((i=DOM.create("a.mm-searchfield__cancel")).setAttribute("href","#"),i.textContent=this.i18n("cancel"),a.append(i));return a},initSearching=function(e){var n=this,t=this.opts.searchfield,s=(this.conf.searchfield,{});e.closest(".mm-panel_search")?(s.panels=DOM.find(this.node.pnls,".mm-panel"),s.noresults=[e.closest(".mm-panel")]):e.closest(".mm-panel")?(s.panels=[e.closest(".mm-panel")],s.noresults=s.panels):(s.panels=DOM.find(this.node.pnls,".mm-panel"),s.noresults=[this.node.menu]),s.panels=s.panels.filter(function(e){return!e.matches(".mm-panel_search")}),s.panels=s.panels.filter(function(e){return!e.parentElement.matches(".mm-listitem_vertical")}),s.listitems=[],s.dividers=[],s.panels.forEach(function(e){var n,t;(n=s.listitems).push.apply(n,DOM.find(e,".mm-listitem")),(t=s.dividers).push.apply(t,DOM.find(e,".mm-divider"))});var i=DOM.children(this.node.pnls,".mm-panel_search")[0],a=DOM.find(e,"input")[0],r=DOM.find(e,".mm-searchfield__cancel")[0];a.mmSearchfield=s,t.panel.add&&t.panel.splash&&(events.off(a,"focus.splash"),events.on(a,"focus.splash",function(e){n.openPanel(i)})),t.cancel&&(events.off(a,"focus.cancel"),events.on(a,"focus.cancel",function(e){r.classList.add("mm-searchfield__cancel-active")}),events.off(r,"click.splash"),events.on(r,"click.splash",function(e){if(e.preventDefault(),r.classList.remove("mm-searchfield__cancel-active"),i.matches(".mm-panel_opened")){var t=DOM.children(n.node.pnls,".mm-panel_opened-parent");t.length&&n.openPanel(t[t.length-1])}})),t.panel.add&&"panel"==t.addTo&&this.bind("openPanel:finish",function(e){e===i&&a.focus()}),events.off(a,"input.search"),events.on(a,"input.search",function(e){switch(e.keyCode){case 9:case 16:case 17:case 18:case 37:case 38:case 39:case 40:break;default:n.search(a)}}),this.search(a)},initNoResultsMsg=function(e){if(e){var n=this.opts.searchfield;this.conf.searchfield;if(e.closest(".mm-panel")||(e=DOM.children(this.node.pnls,".mm-panel")[0]),!DOM.children(e,".mm-panel__noresultsmsg").length){var t=DOM.create("div.mm-panel__noresultsmsg.mm-hidden");t.innerHTML=this.i18n(n.noResults),e.append(t)}}};Mmenu.prototype.search=function(e,n){var t,s=this,i=this.opts.searchfield;this.conf.searchfield;n=(n=n||""+e.value).toLowerCase().trim();var a=e.mmSearchfield,r=e.closest(".mm-searchfield"),m=DOM.find(r,".mm-btn"),l=DOM.children(this.node.pnls,".mm-panel_search")[0],c=a.panels,o=a.noresults,d=a.listitems,f=a.dividers;if(d.forEach(function(e){e.classList.remove("mm-listitem_nosubitems"),e.classList.remove("mm-listitem_onlysubitems"),e.classList.remove("mm-hidden")}),l&&(DOM.children(l,".mm-listview")[0].innerHTML=""),c.forEach(function(e){e.scrollTop=0}),n.length){f.forEach(function(e){e.classList.add("mm-hidden")}),d.forEach(function(e){var t=DOM.children(e,".mm-listitem__text")[0],s=!1;t&&DOM.text(t).toLowerCase().indexOf(n)>-1&&(t.matches(".mm-listitem__btn")?i.showSubPanels&&(s=!0):t.matches("a")?s=!0:i.showTextItems&&(s=!0)),s||e.classList.add("mm-hidden")});var h=d.filter(function(e){return!e.matches(".mm-hidden")}).length;if(i.panel.add){var p=[];c.forEach(function(e){var n=DOM.filterLI(DOM.find(e,".mm-listitem"));if((n=n.filter(function(e){return!e.matches(".mm-hidden")})).length){if(i.panel.dividers){var t=DOM.create("li.mm-divider"),s=DOM.find(e,".mm-navbar__title")[0];s&&(t.innerHTML=s.innerHTML,p.push(t))}n.forEach(function(e){p.push(e.cloneNode(!0))})}}),p.forEach(function(e){e.querySelectorAll(".mm-toggle, .mm-check").forEach(function(e){e.remove()})}),(t=DOM.children(l,".mm-listview")[0]).append.apply(t,p),this.openPanel(l)}else i.showSubPanels&&c.forEach(function(e){var n=DOM.find(e,".mm-listitem");DOM.filterLI(n).forEach(function(e){var n=e.mmChild;n&&DOM.find(n,".mm-listitem").forEach(function(e){e.classList.remove("mm-hidden")})})}),__spreadArrays(c).reverse().forEach(function(n,t){var i=n.mmParent;if(i){var a=DOM.find(n,".mm-listitem");DOM.filterLI(a).length?(i.matches(".mm-hidden")&&i.classList.remove("mm-hidden"),i.classList.add("mm-listitem_onlysubitems")):e.closest(".mm-panel")||((n.matches(".mm-panel_opened")||n.matches(".mm-panel_opened-parent"))&&setTimeout(function(){s.openPanel(i.closest(".mm-panel"))},(t+1)*(1.5*s.conf.openingInterval)),i.classList.add("mm-listitem_nosubitems"))}}),c.forEach(function(e){var n=DOM.find(e,".mm-listitem");DOM.filterLI(n).forEach(function(e){DOM.parents(e,".mm-listitem_vertical").forEach(function(e){e.matches(".mm-hidden")&&(e.classList.remove("mm-hidden"),e.classList.add("mm-listitem_onlysubitems"))})})}),c.forEach(function(e){var n=DOM.find(e,".mm-listitem");DOM.filterLI(n).forEach(function(e){var n=DOM.prevAll(e,".mm-divider")[0];n&&n.classList.remove("mm-hidden")})});m.forEach(function(e){return e.classList.remove("mm-hidden")}),o.forEach(function(e){DOM.find(e,".mm-panel__noresultsmsg").forEach(function(e){return e.classList[h?"add":"remove"]("mm-hidden")})}),i.panel.add&&(i.panel.splash&&DOM.find(l,".mm-panel__content").forEach(function(e){return e.classList.add("mm-hidden")}),d.forEach(function(e){return e.classList.remove("mm-hidden")}),f.forEach(function(e){return e.classList.remove("mm-hidden")}))}else if(d.forEach(function(e){return e.classList.remove("mm-hidden")}),f.forEach(function(e){return e.classList.remove("mm-hidden")}),m.forEach(function(e){return e.classList.add("mm-hidden")}),o.forEach(function(e){DOM.find(e,".mm-panel__noresultsmsg").forEach(function(e){return e.classList.add("mm-hidden")})}),i.panel.add)if(i.panel.splash)DOM.find(l,".mm-panel__content").forEach(function(e){return e.classList.remove("mm-hidden")});else if(!e.closest(".mm-panel_search")){var u=DOM.children(this.node.pnls,".mm-panel_opened-parent");this.openPanel(u.slice(-1)[0])}this.trigger("updateListview")};